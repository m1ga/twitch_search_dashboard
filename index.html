<!DOCTYPE html>

<html>

<head>

	<meta charset="utf-8" />

	<title>Twitch List</title>
	<style>
		* {
			font-size: 30px;
		}
	</style>
	<link rel="stylesheet" type="text/css" href="./main.css" />
	<link rel="stylesheet" type="text/css" href="./fonts/remixicon.css" />
	<script src="socket.io.min.js"></script>
</head>

<body>
	<h1>Twitch Search Dashboard</h1>
	<nav>
		<div class="select_wrapper">
			<select id="topic" onchange="update()">
				<option value="science & technology">science & technology</option>
				<option value="just chatting">just chatting</option>
			</select>
		</div>
		<div class="select_wrapper">
			<select id="language" onchange="update()">
				<option value="all">all</option>
				<option value="de">german</option>
			</select>
		</div>
		<div class="select_wrapper">
			<select id="order" onchange="update()">
				<option value="recent">recent</option>
				<option value="high_low">high to low</option>

			</select>
		</div>
		<button onclick="update();" id="update">update</button>
	</nav>

	<script id="template" type="x-tmpl-mustache">
		{{#data}}
			<div class="user_{{& username}} item">
			<a target="_blank" href=" {{& link }} ">
			<div class="img_container"><img loading="lazy" src="{{& img }} " class="{{& isPartner }} "/></div>
			<div class="title"> {{ title }} </div>

			<div class="infos"> {{ username }} ( {{ viewersCount }} )</div></a>
			<div class="tags">
				{{#tags}}
			    <div> {{ localizedName }} </div>
				{{/tags}}
			</div>
			<div class="block" onclick="blockUser(event, '{{username}}')"> <i class="ri-delete-bin-line"></i> </div>
			</div>
		{{/data}}
	</script>

	<div id="content"></div>
	<button onclick="loadMore()" id="more">load more</button>

	<div id="loader">
		<div class="lds-dual-ring"></div>
	</div>
	<script>
		var socket = io('http://127.0.0.1:3000');
		var template = document.getElementById('template').innerHTML;

		socket.on('data', function(obj) {
			var output = "";
			var rendered = Mustache.render(template, obj);
			if (obj.isAppend) {
				document.getElementById("content").insertAdjacentHTML("beforeend", rendered);
			} else {
				document.getElementById("content").innerHTML = rendered;
			}

			if (obj.hasNextPage == false) {
				document.getElementById("more").style.display = "none";
			} else {
				document.getElementById("more").style.display = "block";
			}

			document.getElementById("loader").classList.remove("visible");
		})

		function update() {
			document.getElementById("loader").classList.add("visible");
			socket.emit("update", {
				topic: document.getElementById("topic").value,
				lang: document.getElementById("language").value,
				order: document.getElementById("order").value
			})
		}

		function loadMore() {
			document.getElementById("loader").classList.add("visible");
			socket.emit("loadMore", {
				topic: document.getElementById("topic").value,
				lang: document.getElementById("language").value,
				order: document.getElementById("order").value
			})
		}

		function blockUser(evt, user) {
			evt.preventDefault();
			var el = document.querySelector(".user_" + user);
			el.parentNode.removeChild(el);

			socket.emit("blockUser", {
				user: user
			})
			return false;
		}
		update();
	</script>
	<script src="mustache.js"></script>
</body>

</html>
